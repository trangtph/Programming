---
title: "Data Exploration"
format: docx
editor: visual
execute: 
  include: false
  echo: false
  warning: false
  message: false
---

```{r include=FALSE, message = FALSE}

# Prep
## Packages

if (!require("pacman", quietly = TRUE)) {
  install.packages("pacman")
}
library(pacman)
pacman::p_load(tidyverse,
               ggplot2,
               rio, #import, export
               here,
               treemap,
               MetBrewer, #color palette
               lubridate, #working with time
               ggrepel,
               listviewer,
               Rtrack,
               d3r,
               RJSONIO
)
```

# Data prep

```{r}
## Data
customers <- import(here("Data", "customers.csv"))
orders <- import(here("Data","orders.csv"))
products <- import(here("Data", "products.csv"))
regions <- import(here("Data", "regions.csv"))
coordinate <- import(here("Processed_data", "nation_region_coordinate.csv" ))

## Remove spaces in column name
customers <- customers %>% rename_with(make.names)
orders <- orders %>% rename_with(make.names)
products <- products %>% rename_with(make.names)
regions <- regions %>% rename_with(make.names)

## Convert date variable to corret type
date_column <- c("OrderDate", "DeliveryDate")
orders <- orders %>% mutate(OrderDate = as.Date(OrderDate, format = "%d/%m/%Y"),
                            DeliveryDate = as.Date(DeliveryDate, format = "%d/%m/%Y"))

col_names <- names(regions)
regions <- regions %>% mutate(across(all_of(col_names), as.factor))

col_names <- names(customers)
customers <- customers %>% mutate(across(all_of(col_names), as.factor))

col_names <- names(products)
products <- products %>% mutate(across(all_of(col_names), as.factor))

```

```{r}
## Get list of nations
nation <- regions %>% distinct(Region, Nation) %>% arrange(Nation)

export(nation, here("Processed_data", "nation_region.csv"))

# merge coordinate info with regions
coordinate2 <- coordinate %>% select (-c("Region"))
regions_coord <- merge(regions, coordinate2, by = "Nation", all.x=TRUE)


## Merge customers and regions:
custom_region <- merge(customers, regions_coord, by = "Territory", all.x = TRUE)

## Merge orders, customers, regions:

order_custom_region <- merge(orders, custom_region, by.x = "CustomerID", by.y = "Account.Code", all.x = TRUE)

```

```{r}
# long data format of orders
order_custom_region_long <- order_custom_region %>% 
  #mutate(Products = gsub(", b", "- b")) %>%
  separate_rows(productsIDs, Quantities, ProductPricesInCP, sep = ", ")

```


```{r}
#merge orders with product
order_custom_region_long$productsIDs <- as.factor(order_custom_region_long$productsIDs)
order_custom_region_long$Quantities <- as.factor(order_custom_region_long$Quantities)
order_custom_region_long$ProductPricesInCP <- as.numeric(order_custom_region_long$ProductPricesInCP)
order_custom_region_product <- merge(order_custom_region_long, products, by.x = "productsIDs", by.y = "product_code", all.x = TRUE)
```

Summary number of customers and revenue per nation 
```{r}
nation_customer <- custom_region %>% count(Nation) %>% arrange(desc(n)) %>% rename(n_customer = n)
nation_revenue <- order_custom_region %>% group_by(Nation) %>% 
  summarise(revenue = sum(CartPriceInCP)) %>% 
  mutate(revenue_round = round(revenue/1000000, digits = 1))
nation_customer_revenue <- merge(nation_customer, nation_revenue, by = "Nation")
nation_customer_revenue2 <- merge(coordinate, nation_customer_revenue, by = "Nation", all.x = TRUE)
nation_customer_revenue2 <- nation_customer_revenue2 %>% mutate(rank_n_customer = min_rank(desc(n_customer)), 
                                                                rank_revenue = min_rank(desc(revenue)))

export(nation_customer_revenue2, here("Processed_data", "nation_customer_revenue.csv"))
summary(nation_customer_revenue2$n_customer)
summary(nation_customer_revenue2$revenue)
```



# 1. Customers distribution

```{r}
##Customers dataset
 ### - Number of customer and territory distribution of them

custom_distribution <- custom_region %>% count(Territory, Nation, Region, Area) %>% arrange(desc(n)) 
custom_distribution

custom_distribution2 <- custom_region %>% count(Nation) %>% arrange(desc(n)) %>% rename(n_customer = n)
custom_distribution2

custom_distribution3 <- custom_region %>% count(Region, Area) %>% arrange(desc(n))
custom_distribution3

custom_distribution4 <- custom_region %>% count(Region) %>% arrange(desc(n))
custom_distribution4
```

```{r include=TRUE }
## Treemap
Renoir = c("#2f357c","#b0799a","#e69b00","#355828","#6c5d9e","#bf3729","#e48171","#f5bb50","#9d9cd5","#17154f","#f6b3b0","#ada43b")

#mycolor = met.brewer("Renoir",n = nrow(custom_distribution2))[1:nrow(custom_distribution2)]

treemap(custom_distribution2, index=c("Region", "Nation"),
        vSize = "n", 
        type = "index",
        title = "Customer distribution", 
        palette = Renoir)
```

-   Number of key account and territory distribution of them

```{r}
key_distribution <- custom_region %>% group_by(Key.Account) %>% summarise(count = n(), percentage = round(count / nrow(custom_region) *100, 1))  %>% arrange(desc(count)) 
key_distribution
```

```{r include=TRUE}
# Bar plot
colors = met.brewer("Renoir", n = nrow(key_distribution), type = "continuous")
ggplot(data = key_distribution, aes(x = reorder(Key.Account, -count), y = count, fill = Key.Account)) +
  geom_bar(stat = "identity") + labs(x = "Key Account", y = "Number of account") + 
  scale_fill_manual(values = colors) + theme_bw() + 
  scale_y_continuous(limits = c(0, 1600)) + 
  geom_text(aes(label=paste(percentage,"%")), vjust=-0.3, size=3.5) + 
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))

```

## Customers that made orders

```{r}
customer_made_order <- order_custom_region %>% count(CustomerID)
summary(customer_made_order$n)
```

All customers made orders

# 2. Product distribution

Product dataset - Number of products per type, contributions of each type in the whole product range

```{r}
type_count <- products %>% count(Type) %>% arrange(desc(n))
type_count

subtype_count <- products %>% count(Type, Subtype) %>% arrange(desc(n))
subtype_count

```

```{r include=TRUE}
## Tree map
treemap(subtype_count, index=c("Type", "Subtype"),
        vSize = "n", 
        type = "index",
        title = "Product distribution", 
        palette = Renoir)
```

# 3. Order distribution

-   Time-serie: Number of order per month and year
-   Time-serie: cart price per month and year

```{r}
## Extract year from order date

order_custom_region2 <- order_custom_region %>% 
  mutate(year_order = as.numeric(format(order_custom_region$OrderDate, "%Y")), 
        month_order = floor_date(OrderDate, "month")) %>%
  relocate(c(year_order, month_order), .after = OrderID)
```

## 3.1. Number of orders per month

```{r}
number_order_year <- order_custom_region2 %>% group_by(year_order) %>% 
  summarise(number_order= n())
number_order_year

number_order_month <- order_custom_region2 %>% group_by(month_order) %>% 
  summarise(number_order= n()) %>%
  mutate(month = rep(1:12, times = 5), year = rep(2019:2023, each = 12))
number_order_month$year <- as.factor(number_order_month$year)
#number_order_month$month <- as.factor(number_order_month$month)
number_order_month

number_order_month_region <- order_custom_region2 %>% 
  group_by(month_order, Region) %>% 
  summarise(number_order= n())
number_order_month_region

```

```{r include=TRUE}
# Number of order per month
ggplot(data = number_order_month, aes(x = month_order, y = number_order)) + 
  geom_point() + geom_line() + 
  labs(x = "Time point", y = "Number of orders placed") +
  scale_x_date(date_breaks = "4 months",
               limits = as.Date(c("2019-01-01", "2023-12-01")), 
               date_labels = "%Y-%m") + 
  theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))
```

```{r}
# Number of order per month
Renoir2 = c("#2f357c","#e69b00","#355828","#6c5d9e","#bf3729","#f6b3b0","#ada43b")

ggplot(data = number_order_month, aes(x = month, y = number_order, group = year, color = year)) + 
  geom_point() + geom_polygon(fill = NA) + 
 xlim(0,12) +
  labs(x = "Month", y = "Number of orders placed") + 
  theme_bw() +
  scale_color_manual(values = Renoir2) + 
  coord_polar()
ggsave(here("Output", "Order_per_month_circular.png"))
```


```{r}
library(plotrix)

radial.plot()
```


### 3.1.1 Number of orders per month by regions

```{r}
Amnian  <- number_order_month_region %>% filter(Region =="Amnian Empire")
Bloodlands   <- number_order_month_region %>% filter(Region =="Bloodlands Empire")
Calim   <- number_order_month_region %>% filter(Region =="Calim Empire")
Dwarven <- number_order_month_region %>% filter(Region =="Dwarven Empire")
Eastern <- number_order_month_region %>% filter(Region =="Eastern Empire")
Halruaan <- number_order_month_region %>% filter(Region =="Halruaan Empire")
Neverwinter <- number_order_month_region %>% filter(Region =="New Neverwinter Empire")
None <- number_order_month_region %>% filter(Region =="None Empire")
Old <- number_order_month_region %>% filter(Region =="Old  Empire")
Purple <- number_order_month_region %>% filter(Region =="Purple Dragon Empire")
Southern  <- number_order_month_region %>% filter(Region =="Southern Empire")

ggplot(data = Amnian, aes(x = month_order, y = number_order)) + 
  geom_point() + geom_line() + 
  labs(x = "Time point", y = "Number of orders placed") +
  scale_x_date(date_breaks = "4 months",
               limits = as.Date(c("2019-01-01", "2023-12-01")), 
               date_labels = "%Y-%m") + 
  theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 )) +
  geom_line(data = Bloodlands, colour = "lightgreen") +
  geom_line(data = Calim, colour = "lightpink") + 
  geom_line(data = Dwarven, colour = "lightgoldenrod") + 
  geom_line(data = Eastern, colour = "lightblue") + 
  geom_line(data = Halruaan, colour = "indianred1") + 
  geom_line(data = Neverwinter, colour = "peru") + 
  geom_line(data = None, colour = "plum") + 
  geom_line(data = Old, colour = "slateblue") + 
  geom_line(data = Purple, colour = "tan1") + 
  geom_line(data = Southern, colour = "turquoise")
```

## 3.2. Sales per month
```{r}
# Total values of product sold per month
amount_order_month <- order_custom_region %>% group_by(month_order) %>% summarise(sales = round(sum(CartPriceInCP)/ 1000000, 2))
amount_order_month
```

```{r include=TRUE}
# Total sales per month
ggplot(data = amount_order_month, aes(x = month_order, y = sales)) + 
  geom_point() + geom_line() + 
  labs(x = "Time point", y = "Total sales (in million CP)") +
  scale_x_date(date_breaks = "4 months",
               limits = as.Date(c("2019-01-01", "2023-12-01")), 
               date_labels = "%Y-%m") + 
  theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))
```


## 3.3 Customer that ordered the most (in terms of cart price)

```{r}
order_customer <- order_custom_region %>% mutate(CustomerID = as.factor(CustomerID)) %>% group_by(CustomerID) %>% summarise(cart_price = round(sum(CartPriceInCP)/1000000, 2)) %>% arrange(desc(cart_price)) %>% slice_head(n = 10)
order_customer

```

```{r include=TRUE}
colors = met.brewer("Renoir", n = nrow(order_customer), type = "discrete")
ggplot(data = order_customer, aes(x = reorder(CustomerID, -cart_price), y = cart_price, fill = CustomerID)) +
  geom_bar(stat = "identity") + labs(x = "Customer ID", y = "Total of order values (in million CP)") + 
  theme_bw() + scale_fill_manual(values = colors) + 
  geom_text(aes(label= cart_price), vjust=-0.3, size=3.5) +  
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))

```

## 3.4. Territory that ordered the most (in terms of cart price)

```{r}
order_territory <- order_custom_region %>% group_by(Territory.x, Nation, Region) %>% 
  summarise(cart_price = round(sum(CartPriceInCP)/1000000, 2)) %>% ungroup %>% 
  arrange(desc(cart_price)) %>% slice_head(n = 10) %>% 
  mutate(terr_nation_region = str_wrap(paste(Territory.x,"(",Nation,"-", Region,")"), width = 20))
order_territory
```

```{r include=TRUE}
colors = met.brewer("Renoir", n = nrow(order_territory), type = "discrete")
order_terr <- ggplot(data = order_territory, aes(x = reorder(terr_nation_region, -cart_price), y = cart_price, fill = terr_nation_region)) +
  geom_bar(stat = "identity") + labs(x = "Territory (Nation - Region)", y = "Total of order values (in million CP)") + 
  theme_bw() + scale_fill_manual(values = colors) + 
  geom_text(aes(label= cart_price), vjust=-0.3, size=3.5) +  
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))

order_terr

ggsave("order_terr.png", 
       order_terr, 
       device = ragg::agg_png, res = 400, units = "in", h = 6, w = 8, path = here("Output"))
```

## 3.5 Most sold products

```{r}
numeric_column <- c("Quantities", "ProductPricesInCP")
order_custom_region_long <- order_custom_region_long %>% mutate(across(all_of(numeric_column), as.numeric))
```

```{r}
product_sale <- order_custom_region_long %>% group_by(Products) %>% 
  summarise(n_order = sum(Quantities)) %>% ungroup  %>% 
  arrange(desc(n_order)) %>% slice(c(1:5, 931:935)) %>% mutate(y = rep(c(1,10), each = 5)) %>%
  mutate(Products = as.factor(Products))
product_sale 
```

```{r include=TRUE}
#Bubble plot
colors = met.brewer("Renoir", n = nrow(product_sale), type = "discrete")
ggplot(data = product_sale, aes(x = reorder(Products, n_order), y = 5)) +
  geom_point(aes(color = Products, size = n_order), shape = 19) + 
  scale_size(range = c(.1, 24)) + 
  scale_y_continuous(breaks = NULL) + theme_bw() + 
  scale_color_manual(values = colors) +
    theme(legend.position = "none", 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 )) + 
  labs(x = "Product", y = "") +
    geom_text(aes(label= n_order), vjust=-0.3, size=3.5)

```

###   Products that were sold the most, per month and year

```{r}
product_sale_year <- order_custom_region_long %>% group_by(year_order, Products ) %>% 
  summarise(n_order = sum(Quantities))  %>% ungroup %>%
  arrange(desc(n_order)) %>% 
  group_by(year_order) %>% slice(1:3)
product_sale_year 
```

```{r include=TRUE}
#Bubble plot
colors = met.brewer("Renoir", n = n_distinct(product_sale_year$Products), type = "discrete")
ggplot(data = product_sale_year, aes(x = as.factor(year_order), y = n_order)) +
  geom_point(aes(color = Products, size = n_order), shape = 19, alpha = 0.5) + 
  scale_size(range = c(.1, 24)) + 
  scale_y_continuous(limits = c(3500, 8500), n.breaks = 10) + theme_bw() + 
  scale_color_manual(values = colors) +
    theme(legend.position = "none" ) + 
  labs(x = "Year", y = "Number of product sold") +
    geom_text_repel(aes(label= paste(Products, n_order, sep ="\n")), size = 3)

```

### Products that brought the most revenue per year

```{r}
product_sale_year2 <- order_custom_region_long %>% group_by(year_order, Products ) %>% 
  summarise(revenue = round(sum(ProductPricesInCP)/1000000, digits =2))  %>% ungroup %>%
  arrange(desc(revenue)) %>% 
  group_by(year_order) %>% slice(1:3)
product_sale_year2 
```

```{r include=TRUE}
#Bubble plot
colors = met.brewer("Renoir", n = n_distinct(product_sale_year2$Products), type = "discrete")
ggplot(data = product_sale_year2, aes(x = as.factor(year_order), y = revenue)) +
  geom_point(aes(color = Products, size = revenue), shape = 19, alpha = 0.5) + 
  scale_size(range = c(.1, 24)) + 
  scale_y_continuous(limits = c(1.7, 5.3), n.breaks = 10) + theme_bw() + 
  scale_color_manual(values = colors) +
    theme(legend.position = "none" ) + 
  labs(x = "Year", y = "Revenue per product (in million CP)") +
    geom_text_repel(aes(label= paste(Products, revenue, sep ="\n")), size = 3)

```

### Product with largest revenue overall
```{r}
hot_product_all <- order_custom_region_product %>% group_by(productsIDs) %>% 
  summarise(revenue_thousand_CP = round(sum(ProductPricesInCP)/1000, digits =2))  %>% ungroup %>%
  arrange(desc(revenue_thousand_CP)) %>% slice(1:10)
hot_product_all2 <- merge(hot_product_all, products, by.x = "productsIDs", by.y = "product_code", all.x = TRUE)

hot_product_all2 <- hot_product_all2 %>% mutate(product_brand = 
                                                  paste0(Product.Name," (", Brand.Name, ")"),
                                                hierarchy = paste(Type,Subtype,product_brand, 
                                                                  sep="-"))
hot_product_all3 <- hot_product_all2 %>% select(hierarchy,revenue_thousand_CP )
hot_product_all3$hierarchy <-  gsub(" ", ".", hot_product_all3$hierarchy)
export(hot_product_all3, here("Processed_data", "hot_product_all.csv"))
```

```{r}
hot_product_all_hierar <- hot_product_all2 %>% 
  select(product_brand, Subtype, revenue_thousand_CP) %>%
  rename(id = product_brand, parentId = Subtype, revenue = revenue_thousand_CP)

subtype <- hot_product_all2 %>% select(Subtype, Type) %>%
  mutate(revenue = NA) %>%
  rename(id = Subtype, parentId = Type)
hot_product_all_hierar2 <- as.data.frame(rbind(hot_product_all_hierar, subtype ))
hot_product_all_hierar2$id <-  gsub(" ", ".", hot_product_all_hierar2$id)
hot_product_all_hierar2$parentId <-  gsub(" ", ".", hot_product_all_hierar2$parentId)

export(hot_product_all_hierar2, here("Processed_data", "hot_product_all_hierar.csv"))
```

```{r}
hot_product_all_nest <- hot_product_all2 %>% 
  select(Type, Subtype, product_brand,revenue_thousand_CP)

hot_product_all_nest2<- hot_product_all_nest %>%
  d3_nest(value_cols = "revenue_thousand_CP", root = "Overall")
hot_product_all_nest2 %>% listviewer::jsonedit()
export(hot_product_all_nest2, here("Processed_data", "hot_product_all_nest.json"))

```

```{r}

makeList<-function(x){
  if(ncol(x)>2){
    listSplit<-split(x[-1],x[1],drop=T)
    lapply(names(listSplit),function(y){list(name=y,children=makeList(listSplit[[y]]))})
  }else{
    lapply(seq(nrow(x[1])),function(y){list(name=x[,1][y],revenue=x[,2][y])})
  }
}


jsonOut<-toJSON(list(name="hot_product_all_nest",children=makeList(hot_product_all_nest[-1])))
cat(jsonOut)

jsonOut %>% listviewer::jsonedit()

export(jsonOut, here("Processed_data", "hot_product_all_hiera.json"))

```


### Product sold the most per country


```{r}
hot_product <- order_custom_region_product %>% group_by(nation_id, Nation, productsIDs ) %>% 
  summarise(revenue_thousand_CP = round(sum(ProductPricesInCP)/1000, digits =2))  %>% ungroup %>%
  arrange(desc(revenue_thousand_CP)) %>% 
  group_by(Nation) %>% slice(1:10)
hot_product_nation <- merge(hot_product, products, by.x = "productsIDs", by.y = "product_code", all.x = TRUE)

export(hot_product2, here("Processed_data", "hot_product.csv"))
```



Try tree map for one nation

```{r}
hot_product_sembia <- hot_product2 %>% filter(Nation == "Sembia")

Renoir = c("#2f357c","#b0799a","#e69b00","#355828","#6c5d9e","#bf3729",
           "#e48171","#f5bb50","#9d9cd5","#17154f","#f6b3b0","#ada43b")

treemap(hot_product_sembia, index=c("Subtype", "Product.Name"),
        vSize = "revenue_thousand_CP", 
        type = "index",
        title = "Product distribution in Sembia", 
        palette = Renoir)
```


# 4. Delivery time
```{r}
# Average time to delivery, by year
order_custom_region <- order_custom_region %>% mutate(delivery_time = as.numeric(difftime(DeliveryDate, OrderDate, units = "days")))

colors = met.brewer("Renoir", n = 5, type = "discrete")

ggplot(order_custom_region, aes(x = as.factor(year_order), y = delivery_time, fill = as.factor(year_order))) + 
  geom_boxplot() + 
  scale_fill_manual(values = colors) +
  theme_bw() + theme(legend.position="none") + 
  labs(x = "Year", y = "Delivery Time") +
  scale_y_continuous(n.breaks = 10)

```

```{r include=TRUE}
#median delivery time

med_delivery_time <- order_custom_region %>% group_by(month_order) %>% summarise(median_delivery_time = median(delivery_time), 
                                                                                 low_quartile = quantile(delivery_time, probs = .25),
                                                                                 up_quartile = quantile(delivery_time, probs = .75))

delivery_time <- ggplot(data = med_delivery_time, aes(x = month_order, y = median_delivery_time)) + 
  geom_ribbon(aes(ymin = low_quartile, ymax = up_quartile), fill = "#6c5d9e", alpha = 0.7) + 
  geom_line(aes(y = median_delivery_time)) + 
  theme_bw() +
  scale_x_date(date_breaks = "4 months",
               limits = as.Date(c("2019-01-01", "2023-12-01")), 
               date_labels = "%Y-%m") + 
  scale_y_continuous(n.breaks = 10) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 )) + 
  labs(x = "Time point", y = "Median delivery time (in days)")
delivery_time

ggsave("delivery_time.png", 
       delivery_time, 
       device = ragg::agg_png, res = 400, path = here("Output"))
  
```
